AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: EC2 instance with a tag containing a random number and Dynamic EBS Volume mapping generated by a Lambda function
Parameters:
  EbsVolumes:
    Type: String
    Default: '[{"DeviceName":"/dev/xvdf","VolumeSize":8,"VolumeType":"gp2"},{"DeviceName":"/dev/xvdg","VolumeSize":16,"VolumeType":"gp2"},{"DeviceName":"/dev/xvdh","VolumeSize":18,"VolumeType":"gp2"}]'
Resources:
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable SSH access via port 22
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0     

  EBSVolumeMappingsLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: random_ebsvolume_map.lambda_handler
      Runtime: python3.8
      CodeUri: s3://my-lambda-package-s3-bucket/dynamic-ebs-volume-map.zip
      Timeout: 2
      Policies:
        - AWSLambdaBasicExecutionRole

  CustomResourceFunction:
    Type: AWS::CloudFormation::CustomResource
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt EBSVolumeMappingsLambdaFunction.Arn
      EbsVolumes: !Ref EbsVolumes

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-04f1014c8adcfa670 # Amazon Linux 2 AMI (HVM), SSD Volume Type
      KeyName: ec2-key-pair
      BlockDeviceMappings: !GetAtt CustomResourceFunction.EBSVolumeMappings
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup      
      Tags:
        - Key: RandomNumber
          Value: !GetAtt CustomResourceFunction.RandomNumber